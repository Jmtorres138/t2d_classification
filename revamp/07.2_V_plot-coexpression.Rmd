---
title: "03.2b_plot-gene-coexpression.Rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup 

```{r}

"%&%" <- function(a,b) paste0(a,b)
library("tidyverse")
library("GenomicRanges")
library("viridis")
library("data.table")
library("plyr")

serv.dir <- "/home/jason/science/servers/FUSE5/"
proj.dir <- serv.dir %&% "projects/t2d_classification/"

work.dir <- proj.dir %&% "revamp/"
analysis.dir <- work.dir %&% "analysis_files/"
plot.dir <- work.dir %&% "plots/"

w.df <- fread(analysis.dir %&% "coexpress-enrich_weighted_p10Coding.txt") %>% 
  na.omit(.)
```



```{r}

plot_enrich <- function(plot.df,nrow1=FALSE){
  plt <- ggplot(data=plot.df,aes(x=tissue,y=enrich.factor)) + 
    geom_point(size=3,aes(shape=geneset,fill=log_pval),
               alpha=0.7) #+ 
    #geom_hline(yintercept = -log(0.05/54,base=10)) + 
    #geom_hline(yintercept = -log(0.05,base=10),linetype=2)
  if (nrow1==TRUE){
    plt <- plt + facet_wrap(~threshold,nrow=1)
  } else{
    plt <- plt + facet_wrap(~threshold)
  }
  plt <- plt + scale_shape_manual(name="Gene set",values=c(21,22,23,24)) +
    scale_fill_viridis(name="-log10(p)",direction = -1) + 
    ylab("Enrichment") + xlab("Tissue") + 
    theme(axis.text.x=element_text(size=14),
          strip.text = element_text(size=17),
          axis.title=element_text(size=17),
          legend.key.size = unit(7,"line")) + 
    coord_flip() + 
    theme_bw()
  return(plt)
}

```


# Filtering 

```{r}

plt1 <- plot_enrich(w.df)
ggsave(plot=plt1,filename = plot.dir %&% "coexpress-enrich_weighted-p10Coding.png",width=12,height=12)


```

# Just 0.2 

```{r}

plt1b <- plot_enrich(filter(w.df,threshold==0.20))

ggsave(plot=plt1b,filename = plot.dir %&% "coexpress-enrich_weighted-noCoding20.png",width=6.5,height=9)
ggsave(plot=plt1b,filename = plot.dir %&% "coexpress-enrich_weighted-noCoding20.pdf",width=6.5,height=9)

```


# Just the four relative tissues 


```{r}

keep.tissues <- c("Islet","Muscle...Skeletal","Liver","Adipose...Subcutaneous")
sub.df <- filter(w.df,tissue %in% keep.tissues)

plt2 <- plot_enrich(sub.df,nrow1=TRUE)
ggsave(plot=plt2,filename = plot.dir %&% "coexpress-enrich_weighted-noCoding-fourtiss.png",width=8,height=4)
ggsave(plot=plt2,filename = plot.dir %&% "coexpress-enrich_weighted-noCoding-fourtiss.pdf",width=8,height=4)
```



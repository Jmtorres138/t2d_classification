---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup 

```{r}

"%&%" <- function(a,b) paste0(a,b)
library("tidyverse")
library("GenomicRanges")
library("viridis")
library("data.table")
library("RColorBrewer")
library("gridExtra")


serv.dir <- "/home/jason/science/servers/FUSE5/"
proj.dir <- serv.dir %&% "projects/t2d_classification/"
work.dir <- proj.dir %&% "revamp/"

analysis.dir <- work.dir %&% "analysis_files/"
plot.dir <- work.dir %&% "plots/"

cred.df <- fread(work.dir %&% "genetic_credible_sets/gencred.txt")
cred.df$Locus.ID <- cred.df$CondID

df <- fread(analysis.dir%&%"classified-loci_weighted_with-shared.txt")

```


# some examples of signals with predominant tissue signatures 

```{r}

(dplyr::select(df,-contains("assigned_")) %>% arrange(.,desc(islet)) %>% filter(.,islet > 0.9))$symbol %>% unique(.)
(dplyr::select(df,-contains("assigned_")) %>% arrange(.,desc(liver)) %>% filter(.,liver > 0.9))$symbol %>% unique(.)
(dplyr::select(df,-contains("assigned_")) %>% arrange(.,desc(adipose)) %>% filter(.,adipose > 0.9))$symbol %>% unique(.)
(dplyr::select(df,-contains("assigned_")) %>% arrange(.,desc(muscle)) %>% filter(.,muscle > 0.9))$symbol %>% unique(.)

```



# Develop "sharing" score

```{r}

df$sep.score <- map(1:dim(df)[1],function(i){
  vec <- df[i,2:6] %>% sort(.,decreasing=TRUE) %>% as.numeric(.)
  vec[1] - vec[2]
}) %>% as.numeric(.)
df$share.score <- 1-df$sep.score

df$num.snps <- map(1:dim(df)[1],function(i){
  id <- df[i,]$Locus.ID
  dim(filter(cred.df,CondID==id))[1]
}) %>% as.integer(.)

df$max.ppa <- map(df$Locus.ID,function(id){
  filter(cred.df,CondID==id)$PPA %>% max(.)
}) %>% as.numeric(.)

sum(df$sep.score > median(df$sep.score))
summary(df$sep.score)

```


## EDA 

Number of SNPs 
```{r}

ggplotRegression <- function (fit) {

require(ggplot2)

ggplot(fit$model, aes_string(x = names(fit$model)[2], y = names(fit$model)[1])) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red") +
  labs(title = paste("Adj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                     "Intercept =",signif(fit$coef[[1]],5 ),
                     " Slope =",signif(fit$coef[[2]], 5),
                     " P =",signif(summary(fit)$coef[2,4], 5)))
}



plt1 <- ggplot(data=df,aes(x=sep.score)) + 
  geom_histogram(color="black",fill=viridis(100)[45]) + 
  xlab("Difference between two highest TOA scores") +
  ylab("Count") + 
  theme(panel.background = element_rect(fill="grey95") )
ggsave(plot=plt1,filename = plot.dir %&% "pleio_eda_1.png",width=5,height=4)
ggsave(plot=plt1,filename = plot.dir %&% "pleio_eda_1.pdf",width=5,height=4)

plt2 <- ggplot(data=df,aes(x=num.snps,y=sep.score)) + 
  geom_point(color="black",shape=21,alpha=0.6,fill=viridis(10)[4]) + 
  xlab("Number of credible SNPs") +
  ylab("Difference between two highest TOA scores") + 
  geom_smooth(method='lm',color=viridis(10)[2]) + 
  theme(panel.background = element_rect(fill="grey95") )

plt2 <- ggplotRegression(lm(sep.score~num.snps,data=df))
plt2 <- plt2 + geom_point(color="black",shape=21,alpha=0.6,fill=viridis(10)[4]) + 
  xlab("Number of credible SNPs") +
  ylab("Difference between two highest TOA scores") + 
  geom_smooth(method='lm',color=viridis(10)[2]) + 
  theme(panel.background = element_rect(fill="grey95"),
        plot.title = element_text(size=9))

ggsave(plot=plt2,filename = plot.dir %&% "pleio_eda_2.png",width=5,height=4)
ggsave(plot=plt2,filename = plot.dir %&% "pleio_eda_2.pdf",width=5,height=4)

plt2b <- ggplotRegression(lm(sep.score~num.snps,data=df))
plt2b <- plt2b + 
  geom_point(color="black",shape=21,alpha=0.6,fill=viridis(10)[4]) + 
  xlab("Number of credible SNPs") +
  ylab("Difference between two highest TOA scores") + 
  coord_cartesian(xlim=c(0,500))  + 
  geom_smooth(method='lm',color=viridis(10)[2]) + 
  theme(panel.background = element_rect(fill="grey95"),
        plot.title = element_text(size=9))
ggsave(plot=plt2b,filename = plot.dir %&% "pleio_eda_2b.png",width=5,height=4)
ggsave(plot=plt2b,filename = plot.dir %&% "pleio_eda_2b.pdf",width=5,height=4)

cor.test(df$num.snps,df$sep.score)
lm(df$sep.score~df$num.snps) %>% summary(.)


```


Maximum PPA 

```{r}

plt3 <- ggplot(data=df,aes(x=max.ppa,y=sep.score)) + 
  geom_point(color="black",shape=21,alpha=0.6,fill=viridis(10)[4]) + 
  xlab("Maximum PPA") +
  ylab("Difference between two highest TOA scores") + 
  geom_smooth(method='lm',color=viridis(10)[2])
ggsave(plot=plt3,filename = plot.dir %&% "pleio_eda_3.png",width=5,height=4)
ggsave(plot=plt3,filename = plot.dir %&% "pleio_eda_3.pdf",width=5,height=4)


cor.test(df$max.ppa,df$sep.score)
lm(df$sep.score~df$max.ppa) %>% summary(.)


```


## "Shared" loci at 10% difference threshold


```{r}

a <- filter(df,sep.score<=0.10)
b <- filter(df,sep.score>0.10)
t.test(a$max.ppa,b$max.ppa)

```



# Profile "shared" signals by fine-mapping resolution 

Fine-mapped to a single SNP

```{r}

s.df <- a
s.df$lead.snp <- map(s.df$Locus.ID,function(id){
  filter(cred.df,CondID==id)$lead.rsid %>% unique(.)
}) %>% as.character(.)

write.table(x=s.df,file=analysis.dir%&%"shared-signals-120.txt",
            sep="\t",quote=F,row.names=F)

s1.df <- filter(s.df,num.snps==1)

View(s1.df)
#s1.df$symbol


tab1.df <- dplyr::select(s1.df,one_of("Locus.ID","lead.snp","symbol","islet",
                                   "muscle","adipose","liver","sep.score")) %>% 
  arrange(.,desc(islet))
names(tab1.df)[c(1,8)] <- c("signal.ID","dissimilarity")
tab1.df$islet <- tab1.df$islet %>% prettyNum(.,digits=2)
tab1.df$adipose <- tab1.df$adipose %>% prettyNum(.,digits=2)
tab1.df$muscle <- tab1.df$muscle %>% prettyNum(.,digits=2)
tab1.df$liver <- tab1.df$liver %>% prettyNum(.,digits=2)
tab1.df$dissimilarity <- tab1.df$dissimilarity %>% prettyNum(.,digits=2)
ggsave(grid.table(tab1.df),filename = plot.dir %&% "shared-single.png",
       height=5,width=10)
ggsave(grid.table(tab1.df),filename = plot.dir %&% "shared-single.pdf",
       height=5,width=10)

```

Fine-mapped to more than one variant, but one variant accounts for >50% of PPA 

```{r}

s2.df <- filter(s.df,num.snps>1,max.ppa>0.5) # 23 signals, including lead signal at TCF7L2, and two signals at HNF4A

tab2.df <- dplyr::select(s2.df,one_of("Locus.ID","lead.snp","symbol","islet",
                                   "muscle","adipose","liver","sep.score")) %>% 
  arrange(.,desc(islet))
names(tab2.df)[c(1,8)] <- c("signal.ID","dissimilarity")
tab2.df$islet <- tab2.df$islet %>% prettyNum(.,digits=2)
tab2.df$adipose <- tab2.df$adipose %>% prettyNum(.,digits=2)
tab2.df$muscle <- tab2.df$muscle %>% prettyNum(.,digits=2)
tab2.df$liver <- tab2.df$liver %>% prettyNum(.,digits=2)
tab2.df$dissimilarity <- tab2.df$dissimilarity %>% prettyNum(.,digits=2)

ggsave(grid.table(tab2.df),filename = plot.dir %&% "shared-mult-maxppa50.png",
       height=10,width=10)
ggsave(grid.table(tab2.df),filename = plot.dir %&% "shared-mult-maxppa50.pdf",
       height=10,width=10)

```

Fine-mapped to more than one variant, but one variant accounts for >50% of PPA 

```{r}

s3.df <- filter(s.df,num.snps>1,max.ppa<=0.5) # 88 signals 
tab3.df <- dplyr::select(s3.df,one_of("Locus.ID","lead.snp","symbol","islet",
                                   "muscle","adipose","liver","sep.score")) %>% 
  arrange(.,desc(islet))
names(tab3.df)[c(1,8)] <- c("signal.ID","dissimilarity")
tab3.df$islet <- tab3.df$islet %>% prettyNum(.,digits=2)
tab3.df$adipose <- tab3.df$adipose %>% prettyNum(.,digits=2)
tab3.df$muscle <- tab3.df$muscle %>% prettyNum(.,digits=2)
tab3.df$liver <- tab3.df$liver %>% prettyNum(.,digits=2)
tab3.df$dissimilarity <- tab3.df$dissimilarity %>% prettyNum(.,digits=2)

ggsave(grid.table(tab3.df),filename = plot.dir %&% "shared-mult-undermpp50.png",
       height=40,width=10)
ggsave(grid.table(tab3.df),filename = plot.dir %&% "shared-mult-undermpp50.pdf",
       height=40,width=10)
```



## Deep dive into a given signal 


```{r}

an.df <- fread(analysis.dir%&%"annotation-divvy-weighted-unscaled.txt")
anall.df <- fread(analysis.dir%&%"annotation-divvy-weighted-unscaled_allSNPs.txt")


```


```{r}

get_sig_df <- function(sig){
  sub.df <- filter(anall.df,Locus.ID==sig)
  sub.df$ppa <- map(sub.df$SNPID,function(id,loc=sig){
    filter(cred.df,CondID==sig,SNPID==id)$PPA %>% max(.)
  }) %>% as.numeric(.)
  sub.df <- arrange(sub.df,desc(ppa))  
}

process_sig_snp <- function(sigsnp.df,ymax=1){
  snpid <- sigsnp.df$SNPID; ppa <- sigsnp.df$ppa
  test.df <- sigsnp.df[,3:(dim(sigsnp.df)[2]-1)]
  #test.df <- sub.df[1,3:(dim(sub.df)[2]-1)]
  annot <- test.df %>% names(.)
  val <- test.df %>% as.numeric(.)
  
  new.df <- data.frame(annot,val,stringsAsFactors = F)
  new.df$Annotation <- map(new.df$annot,function(a){
    strsplit(x=a,split="_")[[1]][1]
  }) %>% as.character(.)
  new.df$Tissue <- map(new.df$annot,function(a){
    strsplit(x=a,split="_")[[1]][2]
  }) %>% as.character(.)
  names(new.df) <- c("annot","score","Annotation","Tissue")
  new.df$Annotation <- factor(new.df$Annotation,
                              levels = c("coding","strongprom","weakprom",
                                         "flankprom","strongenh","weakenh",
                                         "genenh","stronggenetrans","weakgenetrans"))
  p <- ggplot(data=new.df,aes(x=Tissue,y=score)) + 
    geom_bar(aes(fill=Annotation),stat="identity",color="black") + 
    coord_cartesian(ylim=c(0,ymax)) + 
    scale_fill_manual(values=c("grey","firebrick1","firebrick3",
                               "firebrick4","gold1","gold3","yellowgreen",
                               "green1","green4")) + 
    theme_bw() + 
    ggtitle(snpid %&% "\nPPA="%&%round(ppa,3))
  return(list(p,new.df))
}


```


TCF7L2 lead signal 

```{r}

sig <- "130_1"

d <- get_sig_df(sig)
l1 <- process_sig_snp(d[1,],ymax=0.3)
l2 <- process_sig_snp(d[2,],ymax=0.3)
l3 <- process_sig_snp(d[3,],ymax=0.3)


p <- grid.arrange(l1[[1]],l2[[1]],l3[[1]],nrow=1)
write.table(x=d,file=analysis.dir%&%"signal_tcf7l2_130_1.txt",sep="\t",quote=F,row.names=F)
ggsave(plot=p,filename = plot.dir %&% "signal_tcf7l2_130_1.png",h=3.5,w=13)
ggsave(plot=p,filename = plot.dir %&% "signal_tcf7l2_130_1.pdf",h=3.5,w=12.5)


```


KCNJ11 lead signal 

```{r}

sig <- "135_1"

d <- get_sig_df(sig)
l1 <- process_sig_snp(d[1,],ymax=0.3)
l2 <- process_sig_snp(d[2,],ymax=0.3)
l3 <- process_sig_snp(d[3,],ymax=0.3)


p <- grid.arrange(l1[[1]],l2[[1]],l3[[1]],nrow=1)
write.table(x=d,file=analysis.dir%&%"signal_kcnj11_135_1.txt",sep="\t",quote=F,row.names=F)
ggsave(plot=p,filename = plot.dir %&% "signal_kcnj11_135_1.png",h=3.5,w=12)
ggsave(plot=p,filename = plot.dir %&% "signal_kcnj11_135_1.pdf",h=3.5,w=12)


```

GCK lead signal 

```{r}

sig <- "95_1"

d <- get_sig_df(sig)
l1 <- process_sig_snp(d[1,],ymax=1)
l2 <- process_sig_snp(d[2,],ymax=1)


p <- grid.arrange(l1[[1]],l2[[1]],nrow=1)
write.table(x=d,file=analysis.dir%&%"signal_gck_95_1.txt",sep="\t",quote=F,row.names=F)
ggsave(plot=p,filename = plot.dir %&% "signal_gck_95_1.png",h=3.5,w=8)
ggsave(plot=p,filename = plot.dir %&% "signal_gck_95_1.pdf",h=3.5,w=8)


```


GCK secondary signal 

```{r}

sig <- "95_2"

d <- get_sig_df(sig)
l1 <- process_sig_snp(d[1,],ymax=0.3)
l2 <- process_sig_snp(d[2,],ymax=0.3)
l3 <- process_sig_snp(d[3,],ymax=0.3)
l4 <- process_sig_snp(d[4,],ymax=0.3)
l5 <- process_sig_snp(d[5,],ymax=0.3)

p <- grid.arrange(l1[[1]],l2[[1]],l3[[1]],l4[[1]],l5[[1]],nrow=1)
write.table(x=d,file=analysis.dir%&%"signal_gck_95_2.txt",sep="\t",quote=F,row.names=F)
ggsave(plot=p,filename = plot.dir %&% "signal_gck_95_2.png",h=3.5,w=20)
ggsave(plot=p,filename = plot.dir %&% "signal_gck_95_2.pdf",h=3.5,w=15)


```



CCND2 primary signal 

```{r}

sig <- "146_1"

d <- get_sig_df(sig)
l1 <- process_sig_snp(d[1,],ymax=0.6)

p <- grid.arrange(l1[[1]],nrow=1)
write.table(x=d,file=analysis.dir%&%"signal_ccnd1_146_1.txt",sep="\t",quote=F,row.names=F)
ggsave(plot=p,filename = plot.dir %&% "signal_ccnd1_146_1.png",h=3.5,w=5)
ggsave(plot=p,filename = plot.dir %&% "signal_ccnd1_146_1.pdf",h=3.5,w=5)


```


BCL2A primary signal 

```{r}

sig <- "210_1"

d <- get_sig_df(sig)
l1 <- process_sig_snp(d[1,],ymax=0.6)

p <- grid.arrange(l1[[1]],nrow=1)
write.table(x=d,file=analysis.dir%&%"signal_bcl2a_120_1.txt",sep="\t",quote=F,row.names=F)
ggsave(plot=p,filename = plot.dir %&% "signal_bcl2a_120_1.png",h=3.5,w=5)
ggsave(plot=p,filename = plot.dir %&% "signal_bcl2a_120_1.pdf",h=3.5,w=5)


```



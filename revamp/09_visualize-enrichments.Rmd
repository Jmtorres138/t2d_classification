---
title: "visualize-enrichments.Rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Setup 

```{r}

"%&%" <- function(a,b) paste0(a,b)


library("tidyverse")
library("data.table")

serv.dir <- "/home/jason/science/servers/FUSE5/"
#serv.dir <- "/Users/jtorres/FUSE5/"

proj.dir <- serv.dir %&% "projects/t2d_classification/"
work.dir <- proj.dir %&% "revamp/"
plot.dir <- work.dir %&% "plots/"


```



# eQTL enrichments 

```{r}

library("viridis")

firstup <- function(x) {
   substr(x, 1, 1) <- toupper(substr(x, 1, 1))
x
}


eqtl_enrich_plot <- function(enrich.df,myname){
  enrich.df$tissue <- enrich.df$tissue %>% firstup(.)
  enrich.df$eQTL <- enrich.df$eQTL %>% firstup(.)
  plt <- ggplot(data=enrich.df,aes(x=threshold,y=enrichment)) + 
    geom_point(color="black",size=2,shape=21,aes(fill=-log(pvalue,base=10))) + #,shape=as.factor(threshold))) + 
    facet_wrap(~eQTL+tissue) + 
    theme_bw() + 
    scale_y_log10(breaks=c(0.5,2,10,50)) +
    scale_fill_gradient2(low=viridis(n=50)[48],high=viridis(n=50)[10],
                         mid = viridis(n=50)[40],
                         midpoint=-log(0.05,base=10),name=expression(-log10(p))) + 
    xlab("Threshold") + ylab("Enrichment") + 
    ggtitle(myname) +
    theme(axis.text.x=element_text(vjust=0.6),
          panel.grid.minor = element_blank(),
          panel.grid.major.x=element_blank(),
          legend.key = element_rect(color="black",size=3),
          strip.background =element_rect(fill="ghostwhite"),
          strip.text = element_text(colour = magma(n=2)[1]))

}
 
```


```{r}

df2 <- fread(work.dir %&% "analysis_files/eqtl-specific-validation_weighted.txt")

plt2 <- eqtl_enrich_plot(df2,myname="eQTL enrichment for classifed loci (weighted)")
ggsave(plot=plt2,filename = plot.dir %&% "enrichment-eqtl-specific_weighted.png",width=9,height=6.5)


```


```{r}

df4 <- fread(work.dir %&% "analysis_files/downsampled_eqtl-specific-validation_weighted.txt")

plt4 <- eqtl_enrich_plot(df4,myname="eQTL enrichment for classifed loci (weighted, downsampled)")
ggsave(plot=plt4,filename = plot.dir %&% "downsampled_enrichment-eqtl-specific_weighted.png",width=8,height=6)
ggsave(plot=plt4,filename = plot.dir %&% "downsampled_enrichment-eqtl-specific_weighted.pdf",width=8,height=6)

```


# ATAC enrichments 


```{r}

atac_enrich_plot <- function(enrich.df,myname){
  enrich.df$tissue <- enrich.df$tissue %>% firstup(.)
  enrich.df$atac <- enrich.df$atac %>% firstup(.)
  plt <- ggplot(data=enrich.df,aes(x=threshold,y=enrich.factor)) + 
    geom_point(size=2,aes(fill=-log(p.val,base=10)),shape=21) + #shape=as.factor(threshold))) + 
    facet_wrap(~atac+tissue) + 
    theme_bw() + 
    scale_fill_gradient2(low=viridis(n=50)[48],high=viridis(n=50)[10],
                         mid = viridis(n=50)[40],
                         midpoint=-log(0.05,base=10),name=expression(-log10(p))) + 
    xlab("Threshold") + ylab("Enrichment") + 
    ggtitle(myname) +
    theme(axis.text.x=element_text(vjust=0.6),
          panel.grid.minor = element_blank(),
          panel.grid.major.x=element_blank(),
          legend.key = element_rect(color="black",size=3),
          strip.background =element_rect(fill="ghostwhite"),
          strip.text = element_text(colour = magma(n=2)[1]))
}

```


```{r}

read_input <- function(readstring="atac-enrichment_unweighted_thresh"){
  fvec <- list.files(work.dir %&% "analysis_files/")
  fvec <- fvec[grepl(readstring,fvec)]
  out.df <- c()
  for (f in fvec){
    threshold <- "0." %&% (strsplit(x=f,split="thresh")[[1]][2] %>% strsplit(.,".",fixed=TRUE))[[1]][1] %>% 
      as.numeric(.)
    sub <- fread(work.dir%&%"analysis_files/"%&%f)
    sub$threshold <- threshold
    out.df <- rbind(out.df,sub)
  }
  return(out.df)
}


```


```{r}

read_input <- function(readstring="downsample_atac-enrichment_unweighted_thresh"){
  fvec <- list.files(work.dir %&% "analysis_files/")
  fvec <- fvec[grepl(readstring,fvec)]
  out.df <- c()
  for (f in fvec){
    threshold <- "0." %&% (strsplit(x=f,split="thresh")[[1]][2] %>% strsplit(.,".",fixed=TRUE))[[1]][1] %>% 
      as.numeric(.)
    sub <- fread(work.dir%&%"analysis_files/"%&%f)
    sub$threshold <- threshold
    out.df <- rbind(out.df,sub)
  }
  return(out.df)
}

df6 <- read_input("downsample_atac-enrichment_weighted_thresh")


plt6 <- atac_enrich_plot(df6,myname="ATAC enrichment for classifed loci (weighted, downsampled)")
ggsave(plot=plt6,filename = plot.dir %&% "downsampled_enrichment-atac_weighted.png",width=9,height=6.5)


```

Lookups

```{r}

filter(df5,atac=="adipose",tissue=="adipose")
filter(df5,atac=="islet",tissue=="islet")
filter(df5,atac=="liver",tissue=="liver")
filter(df5,atac=="muscle",tissue=="muscle")

filter(df6,atac=="adipose",tissue=="adipose")
filter(df6,atac=="islet",tissue=="islet")
filter(df6,atac=="liver",tissue=="liver")
filter(df6,atac=="muscle",tissue=="muscle")

```


